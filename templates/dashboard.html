<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SLMMS Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body, html { margin:0; padding:0; font-family:'Poppins',sans-serif; background:#f5f6fa; color:#333; transition: all 0.3s; }
.dark-mode { background:#1e1e2f; color:#f5f5f5; }
.topbar { position:fixed; top:0; left:0; width:100%; height:60px; background:#4CAF50; display:flex; align-items:center; padding:0 20px; box-shadow:0 2px 6px rgba(0,0,0,0.15); z-index:100; }
.topbar img {
    height: 40px;
    position: relative;
    border-bottom-left-radius: -50px; 
}  

button { cursor:pointer; padding:8px 14px; border:none; border-radius:6px; background:#4CAF50; color:#fff; font-weight:500; }
button.secondary { background:#e74c3c; }
.sidebar { position:fixed; top:0; left:0; width:250px; height:100%; background:#2f3640; color:#fff; transition: transform 0.3s; transform: translateX(0); padding-top:70px; z-index:99; }
.sidebar.hidden { transform: translateX(-260px); }
.sidebar ul { list-style:none; padding:0; margin:0; }
.sidebar ul li { padding:15px 20px; margin:5px 10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition: background 0.2s; }
.sidebar ul li:hover { background:#3b414d; }
.bubble { background:#e84118; color:#fff; border-radius:50%; padding:4px 8px; font-size:12px; }
.content { margin-left:250px; padding:80px 20px 20px 20px; transition: margin-left 0.3s; }
.content.full { margin-left:0; }
.card { background:#fff; border-radius:10px; padding:20px; margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s; }
.card:hover { transform: translateY(-3px); }
.pc-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:20px; margin-top:20px; }
.pc-card { background:#fff; border-radius:10px; padding:15px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s; }
.pc-card:hover { transform: translateY(-3px); }
.pc-status.online { color:#27ae60; font-weight:600; }
.pc-status.idle { color:#f39c12; font-weight:600; }
.pc-status.offline { color:#e74c3c; font-weight:600; }
.screenshot-thumb { width:120px; height:80px; object-fit:cover; border-radius:6px; cursor:pointer; border:1px solid #ddd; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
.thumb-wrapper { position:relative; display:inline-block; }
.thumb-overlay { position:absolute; inset:0; display:flex; justify-content:center; align-items:center; border-radius:6px; background: rgba(255,255,255,0.6); opacity:0; transition:opacity 0.15s; }
.thumb-overlay.show { opacity:1; }
.spinner { border: 3px solid rgba(0,0,0,0.08); border-top: 3px solid #4CAF50; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.toast-container { position:fixed; right:20px; bottom:20px; z-index:300; display:flex; flex-direction:column; gap:8px; }
.toast { background:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.12); color:#333; min-width:220px; }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-top:20px; }
.stats-card { background:#fff; border-radius:12px; padding:20px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.stats-card h2 { margin:0; font-size:28px; color:#4CAF50; }
.user-card { background:#fff; padding:18px; margin-bottom:15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.user-card:hover { transform: translateY(-2px); }
.actions { display:flex; gap:10px; flex-wrap:wrap; }
.actions input[type="text"] { padding:6px 10px; border-radius:5px; border:1px solid #ccc; min-width:140px; }
.approve-btn { background:#27ae60; color:white; }
.reject-btn { background:#e74c3c; color:white; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:200; }
.modal-content { background:#fff; padding:30px; border-radius:12px; width:350px; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.2); }
.modal-content.dark-mode { background:#2c2c3c; color:#f5f5f5; }
.modal-content input { width:100%; padding:12px; margin:15px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; }
.modal-content button { width:48%; }
.disabled-btn { opacity:0.6; pointer-events:none; }
</style>
</head>
<body>

<div class="topbar">
    <button onclick="toggleSidebar()">☰</button>
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
    <div style="margin-left:auto; display:flex; gap:10px; align-items:center; margin-right:10px;">
        <!-- Auto refresh removed per user's request; we're not polling globally -->
    </div>

</div>

<div class="sidebar" id="sidebar">
    <ul>
        <li onclick="showHome()">Home</li>
        <li onclick="showPending()">Pending Approvals <span class="bubble">{{ pending_users|length }}</span></li>
        <li onclick="showActive()">Active PCs</li>
        <li onclick="showLogs()">Logs</li>
        <li onclick="showSettings()">Settings</li>
        <li onclick="logout()">Logout</li>
    </ul>
</div>

<div class="content" id="content">
    <div id="main-area">
        <h1>Welcome to SLMMS Dashboard</h1>
        <p>Select a menu from the sidebar to view details.</p>

        <!-- PC stats -->
        <div class="stats-grid">
            <div class="stats-card"><h2>{{ pcs_total }}</h2><p>Total PCs</p></div>
            <div class="stats-card"><h2>{{ pcs_online }}</h2><p>Online</p></div>
            <div class="stats-card"><h2>{{ pcs_idle }}</h2><p>Idle</p></div>
            <div class="stats-card"><h2>{{ pcs_offline }}</h2><p>Offline</p></div>
        </div>

        <!-- Pending Users -->
        {% if pending_users %}
        <h2 style="margin-top:30px;">Pending Approvals</h2>
        {% for user in pending_users %}
        <div class="user-card">
            <div>{{ user[1] }} - {{ user[2] }}</div>
            <div class="actions">
                <button onclick="approveUser('{{ user[0] }}')" class="approve-btn">Approve</button>
                <button onclick="openRejectModal('{{ user[0] }}')" class="reject-btn">Reject</button>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- Active PCs with command controls -->
        <h2 style="margin-top:30px;">Active PCs</h2>
        <div class="pc-grid" id="pc-grid">
        {% for p in pcs %}
        <div class="pc-card">
            {% set safe_id = p.id|replace('@','_')|replace('.','_')|replace(':','_')|replace('/','_')|replace(' ','_') %}
            <div style="font-weight:600">{{ p.id }}</div>
            <div class="pc-status {{ p.status|lower }}">{{ p.status }}</div>
            <div style="margin-top:10px;">
                <div class="thumb-wrapper">
                    <img
                        id="screenshot-thumb-{{ safe_id }}"
                        data-client-id="{{ p.id }}"
                        src="{{ url_for('static', filename='screenshots/' ~ p.id ~ '.png') }}?t={{ now }}"
                        alt="Screenshot for {{ p.id }}"
                        class="screenshot-thumb"
                        onerror="onImageError(this)"
                        onclick="openScreenshot('{{ p.id }}')"
                    >
                    <div id="thumb-overlay-{{ safe_id }}" class="thumb-overlay" aria-hidden="true">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; align-items:center;">
                {# Create safe ids by replacing common problematic chars #}
                <select id="cmd-{{ safe_id }}">
                    <option value="screenshot">Screenshot</option>
                    <option value="restart">Restart</option>
                    <option value="shutdown">Shutdown</option>
                </select>
                <button id="send-btn-{{ safe_id }}" onclick="sendCommand('{{ p.id }}', document.getElementById('cmd-{{ safe_id }}').value)">Send</button>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer" aria-live="polite"></div>

<div class="modal" id="rejectModal">
    <div class="modal-content" id="modalContent">
        <h3>Reject User</h3>
        <input type="text" id="rejectReason" placeholder="Enter reason">
        <div style="display:flex; justify-content:space-between;">
            <button onclick="submitReject()" class="reject-btn">Reject</button>
            <button onclick="closeRejectModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Screenshot Modal -->
<div class="modal" id="screenshotModal">
    <div class="modal-content" id="screenshotModalContent" style="max-width:900px; width:95%;">
        <h3 id="screenshotTitle">Screenshot</h3>
        <div style="text-align:center;">
            <img id="screenshotFull" src="" style="max-width:100%; max-height:70vh; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.15);"/>
        </div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:14px;">
            <button id="screenshotDownload" onclick="downloadScreenshot()">Download</button>
            <button onclick="closeScreenshotModal()">Close</button>
        </div>
    </div>
</div>

<script>
let sidebar = document.getElementById('sidebar');
let content = document.getElementById('content');
let modal = document.getElementById('rejectModal');
let modalContent = document.getElementById('modalContent');
let mainArea = document.getElementById('main-area');
let currentRejectId = null;
let currentScreenshotId = null;
let lastMTime = {};
let disabledTimeouts = {}; // map clientId -> timeoutId to re-enable button if no screenshot arrives

function toggleSidebar() { sidebar.classList.toggle('hidden'); content.classList.toggle('full'); }

function showHome() { location.reload(); } // reload main dashboard

// We do not poll globally. We'll poll only per-request when a screenshot command is sent.
function openScreenshot(clientId){
    currentScreenshotId = clientId;
    let img = document.getElementById('screenshotFull');
    let title = document.getElementById('screenshotTitle');
    img.onerror = function(){ img.src = "{{ url_for('static', filename='images/logo.png') }}"; };
    // request metadata from server so we load the correct mtime URL
    fetch(`/screenshot/${clientId}`).then(res=>res.json()).then(data=>{
        if(data && data.exists){
            img.src = data.url + '&_=' + Date.now();
        } else {
            img.src = "{{ url_for('static', filename='images/logo.png') }}";
        }
    }).catch(e=>{ console.error('openScreenshot error', e); img.src = "{{ url_for('static', filename='images/logo.png') }}"; });
    title.textContent = `Screenshot: ${clientId}`;
    document.getElementById('screenshotModal').style.display = 'flex';
}
function closeScreenshotModal(){
    document.getElementById('screenshotModal').style.display = 'none';
    currentScreenshotId = null;
}
function downloadScreenshot(){
    if(!currentScreenshotId) return;
    // ask server for current mtime url and download that
    fetch(`/screenshot/${currentScreenshotId}`).then(res=>res.json()).then(data=>{
        const url = data && data.exists ? data.url + '&_=' + Date.now() : "{{ url_for('static', filename='images/logo.png') }}";
        const link = document.createElement('a');
        link.href = url;
        link.download = `${currentScreenshotId}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }).catch(e=>{ console.error('download screenshot error', e); });
}
// Per-request screenshot polling: After sending a screenshot command, call waitForScreenshot(clientId)
async function waitForScreenshot(clientId, interval=2000, timeout=45000){
    const start = Date.now();
    while(Date.now() - start < timeout){
        try{
            const res = await fetch(`/screenshot/${clientId}`);
            if(res.ok){
                const data = await res.json();
                if(data && data.exists){
                    // update thumbnail
                    const thumb = document.querySelector(`[data-client-id="${clientId}"]`);
                    if(thumb){ thumb.src = data.url + '&_=' + Date.now(); }
                    // if modal open for this client, update full image too
                    if(currentScreenshotId === clientId){ const full = document.getElementById('screenshotFull'); if(full){ full.src = data.url + '&_=' + Date.now(); } }
                    enableSendButton(clientId);
                    showToast(`Screenshot for ${clientId} updated`);
                    return true;
                }
            }
        }catch(e){ console.error('waitForScreenshot error', e); }
        await new Promise(r=>setTimeout(r, interval));
    }
    // timeout: re-enable send button
    enableSendButton(clientId);
    return false;
}

function safeDomId(clientId){
    return clientId.replace(/[@.:\/\s]/g, '_');
}

function disableSendButton(clientId){
    const id = 'send-btn-' + safeDomId(clientId);
    const btn = document.getElementById(id);
    if(btn){ btn.classList.add('disabled-btn'); btn.disabled = true; }
    if(disabledTimeouts[clientId]) clearTimeout(disabledTimeouts[clientId]);
    disabledTimeouts[clientId] = setTimeout(()=>{ enableSendButton(clientId); delete disabledTimeouts[clientId]; }, 45000);
    setThumbnailPending(clientId, true);
}

function enableSendButton(clientId){
    const id = 'send-btn-' + safeDomId(clientId);
    const btn = document.getElementById(id);
    if(btn){ btn.classList.remove('disabled-btn'); btn.disabled = false; }
    if(disabledTimeouts[clientId]){ clearTimeout(disabledTimeouts[clientId]); delete disabledTimeouts[clientId]; }
    setThumbnailPending(clientId, false);
}

function setThumbnailPending(clientId, show){
    const id = 'thumb-overlay-' + safeDomId(clientId);
    const overlay = document.getElementById(id);
    if(!overlay) return;
    overlay.classList.toggle('show', !!show);
}

function showToast(message, timeout=5000){
    const container = document.getElementById('toastContainer');
    if(!container) return;
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = message;
    container.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.addEventListener('transitionend', ()=>t.remove()); }, timeout);
}

function sendCommand(clientId, command){
    if(command === 'screenshot'){
        disableSendButton(clientId);
    }
    fetch('/enqueue-command', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({client_id: clientId, command: command, args: ''})
    }).then(async (res)=>{
        const data = await res.json().catch(()=>({}));
            if(res.ok){
            showToast('Command enqueued');
            if(command === 'screenshot'){
                // start polling only for this client; once screenshot arrives, enable button
                waitForScreenshot(clientId);
            }
        } else if(res.status === 409){
            showToast(data?.message || 'Screenshot already pending');
            if(command === 'screenshot'){ enableSendButton(clientId); }
        } else {
            showToast('Failed to enqueue: ' + (data?.message || res.status));
            if(command === 'screenshot'){ enableSendButton(clientId); }
        }
    }).catch(e=>{ showToast('Failed to enqueue'); if(command === 'screenshot'){ enableSendButton(clientId); } });
}
// Safe image onerror handler — sets fallback image and disables further onerror loops
function onImageError(img){
    if(!img) return;
    try{
        img.onerror = null;
        img.src = "{{ url_for('static', filename='images/logo.png') }}";
    }catch(e){ console.error('onImageError failed', e); }
}
</script>

</body>
</html>
